# Reproducing results of dirac_ens_other_geom with a Hybrid block,
# part of which use ensemble perturbations on the model geometry.
# See explanatory comment in `dirac_ens_other_geom.yaml`.
#
background:
  date: &date '2010-01-01T12:00:00Z'
  state variables: &vars
  - streamfunction
  - velocity_potential

geometry:
  function space: NodeColumns
  grid:
    name: CS-LFR-14
  partitioner: cubedsphere
  groups: &var_groups
  - variables: *vars
    levels: 70
  halo: 1

background error:
  covariance model: SABER
  saber central block:
    saber block name: Hybrid
    components:
    - weight:
        value: 0.5
      covariance:
        ensemble pert:
          date: *date
          members from template:
            pattern: '%MEM%'
            nmembers: 2
            template:
              date: *date
              filepath: testdata/process_perts_from_csdual_states_2/wb1_CS-LFR-14_mb%MEM%_inc
              variables: *vars
        saber central block:
          saber block name: Ensemble
    - weight:
        value: 0.5
      covariance:
        ensemble geometry:
          function space: StructuredColumns
          grid:
            type: regular_gaussian
            N: 14
          halo: 1
          groups: *var_groups
        ensemble pert on other geometry:
          date: *date
          members from template:
            pattern: '%MEM%'
            nmembers: 2
            template:
              date: *date
              filepath: testdata/process_perts_from_csdual_states_2/wb1_F14_inc_%MEM%
              variables: *vars
        saber central block:
          saber block name: Ensemble
          # FunctionSpace-specific localization, not on model Geometry.
          localization:
            saber central block:
              saber block name: ID
            saber outer blocks:
            - saber block name: spectral analytical filter
              # Equivalent to no localization level by level (but full inter-level and
              # inter-variables localization), to allow comparison with other component
              function:
                shape: boxcar
                waveband min: 0
                waveband max: 0
                waveband amplitude: 1.0
              normalize filter variance: true
            - saber block name: spectral to gauss
        saber outer blocks:
        - saber block name: gauss to cubed-sphere-dual
          gauss grid uid: F14

dirac: &dirac
  lon:
  - 180.0
  lat:
  - 3.672
  level:
  - 1
  variable:
  - streamfunction

diagnostic points: *dirac

increment variables: *vars

output dirac:
  mpi pattern: '%MPI%'
  filepath: testdata/dirac_ens_both_geom/dirac_%id%_%MPI%

test:
  float relative tolerance: 8e-5  # Due to process_perts_from_csdual_states_2 outputs differing on 1/2 MPI tasks
  reference filename: testref/dirac_ens_both_geom.ref
