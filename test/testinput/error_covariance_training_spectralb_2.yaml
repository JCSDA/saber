# The idea of this test is to read ensemble perturbations generated via the
# the randomize method and generate spectral vertical covariances and
# variances / vertical covariances in grid point space.
# These spectral vertical covariances should be similar to the original
# spectral vertical covariances used by the randomization method.
geometry:
  function space: StructuredColumns
  grid:
    type: regular_gaussian
    N: 12
  groups:
  - variables: &vars
    - eastward_wind
    - mu
    - northward_wind
    - streamfunction
    - unbalanced_pressure_levels_minus_one
    - velocity_potential
    levels: 70
  partitioner: ectrans
background:
  date: 2010-01-01T12:00:00Z
  state variables: &inputvars
  - eastward_wind
  - mu
  - northward_wind
  - unbalanced_pressure_levels_minus_one
background error:
  covariance model: SABER
  ensemble pert:
    date: 2010-01-01T12:00:00Z
    members from template:
      template:
        date: 2010-01-01T12:00:00Z
        filepath: testdata/randomization_sqrtspectralb_3/randomized_gauss_mb%mem%
      pattern: '%mem%'
      nmembers: 10
  saber central block:
    saber block name: spectral covariance
    active variables:
    - mu
    - streamfunction
    - unbalanced_pressure_levels_minus_one
    - velocity_potential
    calibration:
      write:
        covariance name: "specvertcov2"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_2/spectralvertcov_%MPI%.nc
  saber outer blocks:
  - saber block name: spectral to gauss
    calibration: true
    active variables: *vars
  - saber block name: write variances
    additional cross covariances:
    - variable 1: eastward_wind
      variable 2: northward_wind
    - variable 1: eastward_wind
      variable 2: mu
    - variable 1: northward_wind
      variable 2: mu
    binning:
      type: "horizontal global average"
    calibration:
      write:
        covariance name: "randomization with F12 mesh"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_2/variances_1_%MPI%.nc
    field names: *inputvars
    save NetCDF file: true
    statistics type:  "variance"
  - saber block name: write variances
    field names: *inputvars
    binning:
      type: "horizontal grid point"
      mpi rank pattern: '%MPI%'
      file path: testdata/error_covariance_training_spectralb_2/hor_gri_ave_%MPI%.nc
    calibration:
      write:
        covariance name: "randomization with F12 mesh"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_2/variances_2_%MPI%.nc
    save NetCDF file: true
    statistics type:  "variance"
  - saber block name: write variances
    additional cross covariances:
    - variable 1: eastward_wind
      variable 2: northward_wind
    - variable 1: eastward_wind
      variable 2: mu
    - variable 1: northward_wind
      variable 2: mu
    binning:
      type: "horizontal global average"
      mpi rank pattern: '%MPI%'
      file path: testdata/error_covariance_training_spectralb_2/hor_glo_ave_%MPI%.nc
    calibration:
      write:
        covariance name: "randomization with F12 mesh"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_2/vertcov_1_%MPI%.nc
    field names: *inputvars
    save NetCDF file: true
    statistics type:  "vertical covariance"
test:
  reference filename: testref/error_covariance_training_spectralb_2.ref
