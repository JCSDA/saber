geometry:
  function space: NodeColumns
  grid:
    name: CS-LFR-14
  partitioner: cubedsphere
  groups:
  - variables: &vars
    - streamfunction
    - velocity_potential
    levels: 70
  halo: 1

background:
  date: &date '2010-01-01T12:00:00Z'
  state variables: *vars

bands:
- band:
    filter:
      saber central block:
        saber block name: ID
      saber outer blocks:
      - saber block name: spectral analytical filter
        function:
          shape: waveband filter
          waveband min: 0
          waveband peak: 1
          waveband max: 3
        preserving variance: true
        active variables: *vars
      - saber block name: spectral to gauss
        active variables: *vars
        filter mode: true # instead of running the adjoint code it runs the inverse
      - saber block name: write variances
        field names: *vars
        multiply fset filename: wb1_F14_variance
        output path: testdata/process_perts_from_csdual_states_2/
      - saber block name: write fields
        output path: testdata/process_perts_from_csdual_states_2/
        multiply fset filename: wb1_F14_inc
      - saber block name: gauss to cubed-sphere-dual
        gauss grid uid: F14
        filter mode: true # instead of running the adjoint code it runs the inverse
      - saber block name: write variances
        field names: *vars
        filter mode: true # instead of running the adjoint code it runs the inverse
        left inverse fset filename: initial_CS14_variance
        output path: testdata/process_perts_from_csdual_states_2/
- band:
    filter:
      saber central block:
        saber block name: ID
      saber outer blocks:
      - saber block name: spectral analytical filter
        function:
          shape: waveband filter
          waveband min: 1
          waveband peak: 3
          waveband max: 9
        preserving variance: true
        active variables: *vars
      - saber block name: spectral to gauss
        active variables: *vars
        filter mode: true # instead of running the adjoint code it runs the inverse
      - saber block name: write variances
        field names: *vars
        multiply fset filename: wb2_F14_variance
        output path: testdata/process_perts_from_csdual_states_2/
      - saber block name: write fields
        output path: testdata/process_perts_from_csdual_states_2/
        multiply fset filename: wb2_F14_inc
      - saber block name: gauss to cubed-sphere-dual
        gauss grid uid: F14
        filter mode: true # instead of running the adjoint code it runs the inverse
- band:
    filter:
      saber central block:
        saber block name: ID
      saber outer blocks:
      - saber block name: spectral analytical filter
        function:
          shape: waveband filter
          waveband min: 3
          waveband peak: 9
          waveband max: 23 # last waveband max need to be 2N - 1
        preserving variance: true
        complement filter: true
        active variables: *vars
      - saber block name: spectral to gauss
        active variables: *vars
        filter mode: true # instead of running the adjoint code it runs the inverse
      - saber block name: gauss to cubed-sphere-dual
        gauss grid uid: F14
        filter mode: true # instead of running the adjoint code it runs the inverse
    use residual from filter: true
  output:
    diagnostic only block:
      saber central block:
        saber block name: ID
      saber outer blocks:
      - saber block name: write variances
        output path: testdata/process_perts_from_csdual_states_2/
        multiply fset filename: wb3_cs14_variance
    generic write:
      filepath: testdata/process_perts_from_csdual_states_2/wb3_%GRID%_mb%MEM%_inc
      member pattern: '%MEM%'
      grid pattern: '%GRID%'

input variables: *vars

ensemble:
  members:
  - date: *date
    filepath: testdata/randomization_csdual_sqrtspectralb/1_randomized_csdual_mb1
    state variables: *vars
  - date: *date
    filepath: testdata/randomization_csdual_sqrtspectralb/1_randomized_csdual_mb2
    state variables: *vars

test:
  float relative tolerance: 5.0e-6       # default value of 1.0e-6
  reference filename: testref/process_perts_from_csdual_states_2.ref
