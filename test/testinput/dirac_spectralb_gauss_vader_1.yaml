# met office covariance on gaussian mesh without super saber blocks
# should give same dirac test results as dirac_spectralb_gauss_vader_2
geometry:
  function space: StructuredColumns
  grid:
    type: regular_gaussian
    N: 12
  groups:
  - variables:
    - air_pressure
    - air_pressure_levels_minus_one
    - air_temperature
    - cfeff
    - cleff
    - cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
    - cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
    - dlsvpdT
    - dry_air_density_levels_minus_one
    - eastward_wind
    - exner
    - exner_levels_minus_one
    - geostrophic_pressure_levels_minus_one
    - height
    - ice_cloud_volume_fraction_in_atmosphere_layer
    - liquid_cloud_volume_fraction_in_atmosphere_layer
    - mu
    - muA
    - muH1
    - muRecipDeterminant
    - muRow1Column1
    - muRow1Column2
    - muRow2Column1
    - muRow2Column2
    - m_ci
    - m_cl
    - m_r
    - m_t
    - m_v
    - northward_wind
    - potential_temperature
    - qrain
    - qsat
    - qt
    - rht
    - specific_humidity
    - streamfunction
    - svp
    - unbalanced_pressure_levels_minus_one
    - velocity_potential
    - virtual_potential_temperature
    levels: 70
  - variables:
    - air_pressure_levels
    - height_levels
    - hydrostatic_exner_levels
    - hydrostatic_pressure_levels
    levels: 71
  partitioner: ectrans
  halo: 1

increment variables:
- dry_air_density_levels_minus_one
- eastward_wind
- exner_levels_minus_one
- cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
- cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
- northward_wind
- potential_temperature
- specific_humidity

background error:
  covariance model: SABER
  adjoint test: true
  inverse test: true
  # Small tolerances to illustrate local overriding in saber blocks:
  adjoint tolerance: 1e-12
  inverse tolerance: 1e-13
  saber central block:
    saber block name: spectral covariance
    active variables:
    - mu
    - streamfunction
    - unbalanced_pressure_levels_minus_one
    - velocity_potential
    read:
      covariance_file: testdata/spectralcov.nc
      umatrix_netcdf_names:
      - MU_inc_Uv_matrix
      - PSI_inc_Uv_matrix
      - aP_inc_Uv_matrix
      - CHI_inc_Uv_matrix
  saber outer blocks:
  - saber block name: spectral to gauss
    active variables:
    - eastward_wind
    - mu
    - northward_wind
    - streamfunction
    - unbalanced_pressure_levels_minus_one
    - velocity_potential
  - saber block name: gauss winds to geostrophic pressure
    skip inverse test: true  # Tested within mo_hydrostatic_pressure block
  - saber block name: mo_hydrostatic_pressure_from_geostrophic_pressure
    skip inverse test: true  # Tested within mo_hydrostatic_pressure block
    covariance data:
      covariance file path: testdata/FPstats.nc
      number of covariance latitude rings: 481
      gp regression bins: 18
  - saber block name: mo_hydrostatic_pressure_to_hydrostatic_exner
  - saber block name: mo_hydro_bal
    inner variables to compare: [hydrostatic_exner_levels]
    outer variables to compare: [virtual_potential_temperature, air_pressure_levels]
  - saber block name: mo_moisture_control
    adjoint tolerance: 2e-12
    inner variables to compare:
      - mu
      - virtual_potential_temperature
    covariance data:
      covariance file path: testdata/MUstats.nc
  - saber block name: mo_hydrostatic_pressure_hydrostatic_exner_to_pressure_exner
  - saber block name: mo_air_temperature
    skip inverse test: true
  - saber block name: mo_moistincrop
    skip inverse test: true  # Tested within the mo_super_mio block
    moisture incrementing operator file: testdata/MIO_coefficients.nc
  - saber block name: mo_dry_air_density
    skip inverse test: true

dirac:
  lon:
  - 0.0
  lat:
  - 3.672
  level:
  - 1
  variable:
  - dry_air_density_levels_minus_one

diagnostic points:
  lon:
  - 180.0
  - 0.0
  - 0.0
  lat:
  - 3.672
  - 84.37
  - 3.672
  level:
  - 1
  - 1
  - 70
  variable:
  - dry_air_density_levels_minus_one
  - dry_air_density_levels_minus_one
  - dry_air_density_levels_minus_one

background:
  date: 2016-01-01T16:00:00Z
  state variables:
  - air_pressure  # for moistincrop block
  - air_pressure_levels_minus_one  # for dry_air_density block
  - exner # for moisture_control block
  - exner_levels_minus_one  # for air_temperature block
  - height  # state variable in quench only, for dry_air_density block
  - height_levels  # state variable in quench only, for dry_air_density block
  - ice_cloud_volume_fraction_in_atmosphere_layer  # for moistincrop block
  - liquid_cloud_volume_fraction_in_atmosphere_layer  # for moistincrop block
  - m_ci  # for dry_air_density block
  - m_cl  # for dry_air_density block
  - m_r  # for dry_air_density block
  - m_v  # for dry_air_density block
  - potential_temperature  # for dry_air_density block
  filepath: testdata/gauss_state

output dirac:
  mpi pattern: '%MPI%'
  filepath: testdata/dirac_spectralb_gauss_vader_1/dirac_%id%_%MPI%

test:
  reference filename: testref/dirac_spectralb_gauss_vader_1.ref
